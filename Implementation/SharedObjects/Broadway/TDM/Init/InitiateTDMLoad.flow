tags: TDM
stages:
  Get Init Run Indicator:
    remark: |
      The initiation includes the following steps:
      1. Set Environment to source Environment, in case entity should be synced from source
      2. Set Sync Mode based on task's parameters
      3. Get Entity from Fabric
      4. Set Environment to Target Environment
      5. Set task parameters as session variables:
      5.1 Source Environment
      5.2 Target Environment
      5.3 Sync Mode
      5.4 Delete Before Load Indicator
      5.5 Insert To Target Indicator
      5.6 Replace Sequence Indicator
      5.7 Masking Indicator
      5.8 Data Flux Indicator
      5.9 Hierarchy Indicator
      5.10 Root Indicator
      5.11 Parent LU Type
      5.12 Clone Indicator
      6. Set the given Globals
      7. In case of Cloning handle the Clone Number
    actors:
      SCOPE_INITIATED:
        parent: FabricSetRead
        in:
          key:
            const: SCOPE_INITIATED
            default: false
  Check If Init Did Not Run:
    actors:
      Already ran?:
        parent: IsNull
        condition: result
        in:
          value:
            link: SCOPE_INITIATED/result
  Print Inputs:
    actors:
      Set Initiation Flag to True:
        parent: FabricSet
        in:
          key:
            const: SCOPE_INITIATED
            default: false
          value:
            const: 'true'
      Print Inputs to Log:
        parent: Logger
        in:
          message:
            const: 'TDMOrchestrator --> Handling task with following parameters: iid:
              ${iid}, luType: ${luName}, syncMode: ${syncMode}'
          level:
            const: info
          iid:
            external: iid
            schema: string
          luName:
            external: luName
            schema: string
          syncMode:
            external: syncMode
            schema: string
            mandatory: false
      Get Source Environment:
        parent: FabricSetRead
        in:
          key:
            const: TDM_SOURCE_ENVIRONMENT_NAME
            default: false
      'Get AI Environment ':
        parent: FabricSetRead
        in:
          key:
            const: AI_ENVIRONMENT
            default: false
      Get TDMDB Schema:
        parent: FabricSetRead
        in:
          key:
            const: TDMDB_SCHEMA
            default: false
  Set Environment To Source:
    actors:
      Get Start Time:
        parent: Now
      Set Source Environment:
        parent: FabricSet
        height: 106
        in:
          key:
            const: environment
            default: false
          value:
            const: null
            link: Get Source Environment/result
            default: false
      Initiate Source Entity ID:
        parent: FabricSet
        remark: The Source Entity ID should be initiated in case the flows fails during
          the next stage and before setting this ID as it is used in the Error handler
        in:
          key:
            const: SOURCE_ENTITY_ID
            default: false
          value:
            const: null
            external: iid
            default: false
      Initiate IID:
        parent: FabricSet
        remark: The IID should be initiated in case the flows fails during the next
          stage and before setting this ID as it is used in the Error handler
        in:
          key:
            const: IID
            default: false
          value:
            const: null
            external: iid
            default: false
      Initiate Target Entity ID:
        parent: FabricSet
        remark: The Target Entity ID should be initiated in case the flows fails during
          the next stage and before setting this ID as it is used in the Error handler
        in:
          key:
            const: TARGET_ENTITY_ID
            default: false
          value:
            const: null
            external: iid
            default: false
      Set sequence_schema:
        parent: FabricSet
        in:
          key:
            const: sequence_schema
            default: false
          value:
            const: null
            link: Get TDMDB Schema/result
            default: false
      set Sync Mode:
        parent: FabricSet
        in:
          key:
            const: sync
            default: false
          value:
            external: syncMode
      Get Sync Mode:
        parent: Const
        in:
          value:
            const: null
            external: syncMode
        out:
          value:
            schema: string
      get LU_ID:
        parent: FabricSetRead
        in:
          key:
            const: LU_ID
            default: false
      get TDM_TASK_EXE_ID:
        parent: FabricSetRead
        in:
          key:
            const: TDM_TASK_EXE_ID
            default: false
  Check AI Generation Conditions:
    actors:
      'Source is AI ':
        parent: EqualsIgnoreCase
        in:
          a:
            link: Get Source Environment/result
          b:
            link: Get AI Environment /result
      Sync is OFF:
        parent: EqualsIgnoreCase
        in:
          b:
            const: 'off'
            schema: string
          a:
            link: Get Sync Mode/value
      Get Selection Method:
        parent: DbCommand
        in:
          interface:
            const: TDM
          sql:
            const: "select selection_method\r\nfrom ${@TDMDB_SCHEMA}.tasks t INNER\
              \ JOIN ${@TDMDB_SCHEMA}.task_execution_list l on t.task_id=l.task_id\
              \ \r\nwhere task_execution_id = ${task-execution_id}"
          TDMDB_SCHEMA:
            link: Get TDMDB Schema/result
            schema: string
            mandatory: false
          task-execution_id:
            link: get TDM_TASK_EXE_ID/result
            schema: string
            mandatory: false
        out:
          result:
            schema: '#ref'
  Check selection Method:
    actors:
      AI_GENERATED:
        parent: EqualsIgnoreCase
        in:
          b:
            const: AI_GENERATED
            schema: string
          a:
            link:
              path: Get Selection Method/result/selection_method
              iterate: First
      Sync is OFF and Source is AI:
        parent: And
        in:
          a:
            link: Source is AI /result
          b:
            link: Sync is OFF/result
  Sync Is OFF:
    dependsOn: Check selection Method
    actors:
      All Conditions:
        parent: And
        condition: result
        in:
          a:
            link: AI_GENERATED/result
          b:
            link: Sync is OFF and Source is AI/result
      Get Root Lui and Name:
        parent: DbCommand
        in:
          interface:
            const: TDM
          sql:
            const: "select root_lu_name ,root_imported_lui from ${@TDMDB_SCHEMA}.tdm_ai_gen_iid_mapping\r\
              \nwhere lu_name=${lu_name} and imported_lui=${iid} and task_execution_id=${task_execution_id}"
          iid:
            external: iid
            schema: string
            mandatory: false
          task_execution_id:
            link: get TDM_TASK_EXE_ID/result
            schema: string
            mandatory: false
          lu_name:
            external: luName
            schema: string
            mandatory: false
          TDMDB_SCHEMA:
            link: Get TDMDB Schema/result
            schema: string
            mandatory: false
        out:
          result:
            schema: '#ref'
    split: '--------------------'
  'Else ':
    else: true
    transactional: false
    dependsOn: Check selection Method
  Extracting the iid:
    dependsOn: Sync Is OFF
    actors:
      Regex:
        parent: Regex
        in:
          pattern:
            const: (?<=_)(\d+)(?=_)
          input:
            link: Get Root Lui and Name/result/root_imported_lui
    split: '--------------------'
  'Do Nothing  ':
    transactional: false
    dependsOn: 'Else '
  'Set Root Lu ':
    dependsOn: Extracting the iid
    actors:
      Set root_lu_name:
        parent: FabricSet
        in:
          key:
            const: root_lu_name
            default: false
          value:
            const: null
            link:
              path: Get Root Lui and Name/result/root_lu_name
              iterate: First
            default: false
      Set root_iid:
        parent: FabricSet
        in:
          key:
            const: root_iid
            default: false
          value:
            const: null
            link:
              path: Regex/strings
              iterate: First
            default: false
    split: '--------------------'
  Do Nothing:
    transactional: false
    dependsOn: 'Do Nothing  '
  Set TDM Parameters:
    transactional: false
    actors:
      Set Lu Name:
        parent: FabricSet
        in:
          key:
            const: LU_TYPE
            default: false
          value:
            const: null
            external: luName
            default: false
      Format Start Time:
        parent: DateFormat
        in:
          date:
            link: Get Start Time/date
      Set Input IID:
        parent: FabricSet
        in:
          key:
            const: INPUT_IID
            default: false
          value:
            const: null
            external: iid
            default: false
  Set The given Globals:
    remark: The task receives a set of  Globals, these Globals will be set at this
      stage to impact the run of the Entity loading.
    transactional: false
    actors:
      Split IID And Clone Number:
        parent: SplitIIDAndCloneNumber_Actor
        height: 265
        in:
          iid:
            external: iid
        out:
          cloneNo:
            schema: string
          UID:
            schema: string
          versionExeID:
            schema: string
      Set Start Processing Time:
        parent: FabricSet
        in:
          key:
            const: IID_START_DATETIME
            default: false
          value:
            link: Format Start Time/string
      get TDM Task Execution ID:
        parent: getLUVariable_Actor
        in:
          variableName:
            const: TDM_TASK_EXE_ID
          luName:
            external: luName
  Get Values of Globals And Set Indicators And IDs:
    transactional: false
    actors:
      Get Target Environment:
        parent: FabricSetRead
        in:
          key:
            const: TDM_TAR_ENV_NAME
            default: false
      Get Source Environment DC:
        parent: DbFetchField
        in:
          interface:
            const: TDM
          sql:
            const: "select p.data_center_name from ${@schema}.environment_products\
              \ p, ${@schema}.task_execution_list l, ${@schema}.tasks_logical_units\
              \ u\r\nwhere l.task_execution_id=${taskExeID} and  l.task_id = u.task_id\
              \ and l.lu_id = u.lu_id and u.lu_name = ${luName}\r\nand l.source_environment_id=\
              \ p.environment_id and l.product_id = p.product_id\r\n"
          taskExeID:
            link: get TDM Task Execution ID/variableValue
            schema: string
          luName:
            external: luName
            schema: string
          schema:
            link: Get TDMDB Schema/result
            schema: string
            mandatory: false
        out:
          result:
            schema: string
      Set IID:
        parent: FabricSet
        in:
          key:
            const: IID
            default: false
          value:
            link: Split IID And Clone Number/instanceID
      Set Clone No:
        parent: FabricSet
        in:
          key:
            const: clone_id
            default: false
          value:
            const: '0'
            link: Split IID And Clone Number/cloneNo
      Initiate Target Entity ID after IID Split:
        parent: FabricSet
        remark: The Target Entity ID should be initiated in case the flows fails during
          the next stage and before setting this ID as it is used in the Error handler
        in:
          key:
            const: TARGET_ENTITY_ID
            default: false
          value:
            const: null
            link: Split IID And Clone Number/instanceID
            default: false
      Initiate Instance ID:
        parent: FabricSet
        in:
          key:
            const: SOURCE_INSTANCE_ID
            default: false
          value:
            const: null
            link: Split IID And Clone Number/instanceID
            default: false
      Set Source Entity ID:
        parent: FabricSet
        height: 110
        in:
          key:
            const: SOURCE_ENTITY_ID
            default: false
          value:
            const: null
            link: Split IID And Clone Number/UID
            default: false
      Set Task Execution ID:
        parent: FabricSet
        in:
          key:
            const: execution_id
            default: false
          value:
            const: null
            link: get TDM Task Execution ID/variableValue
            default: false
  Stage 2:
    transactional: false
    actors:
      IfElse1:
        parent: IfElse
        height: 496
        in:
          a:
            link: Split IID And Clone Number/UID
            schema: string
          b:
            external: iid
            schema: string
          test:
            link: Split IID And Clone Number/cloneNo
        out:
          result:
            schema: string
  Get Instance From Fabric:
    transactional: false
    dependsOn: Stage 2
    actors:
      Check if Source Env has DC:
        parent: IsNull
        condition: result
        height: 144
        in:
          value:
            link: Get Source Environment DC/result
      ErrorHandler1:
        parent: ErrorHandler
        error: result
        in:
          config:
            const:
            - exceptionKey: java.lang.Exception
              conditions:
                message: ''
              actions:
                suppress: false
                log: true
                flowName: PopulateTableErrorsWithFailed
      Get Entity:
        parent: FabricGet
        in:
          luType:
            const: null
            external: luName
          iid:
            const: null
            link: IfElse1/result
            default: false
          syncMode:
            const: null
            external: syncMode
        out:
          result:
            schema: '#ref'
      Get Time After Get:
        parent: Now
    split: '--------------------'
  'DC not Null ':
    else: true
    transactional: false
    dependsOn: Stage 2
    actors:
      ErrorHandler2:
        parent: ErrorHandler
        error: result
        in:
          config:
            const:
            - exceptionKey: java.lang.Exception
              conditions:
                message: ''
              actions:
                suppress: false
                log: true
                flowName: PopulateTableErrorsWithFailed
      Get Entity with Source DC:
        parent: DbCommand
        in:
          interface:
            const: fabric
          sql:
            const: get ${luName}.${iid} @ ${dcName} WITH PARALLEL=false STOP_ON_ERROR=true
          luName:
            external: luName
            schema: string
          iid:
            link: IfElse1/result
            schema: string
          dcName:
            link: Get Source Environment DC/result
            schema: string
        out:
          result:
            schema: '#ref'
      Get Time After Get With DC:
        parent: Now
  Get LOAD_MASKING_FLAG:
    transactional: false
    actors:
      Get Load Masking Flag:
        parent: FabricSetRead
        in:
          key:
            const: LOAD_MASKING_FLAG
            default: false
  Set Environment To Target:
    transactional: false
    actors:
      Set Target Environment:
        parent: FabricSet
        in:
          key:
            const: environment
            default: false
          value:
            const: null
            link: Get Target Environment/result
            default: false
      Initiate Entity Status:
        parent: FabricSet
        in:
          key:
            const: ENTITY_STATUS
            default: false
          value:
            const: completed
            default: false
      Format Current Time:
        parent: DateFormat
        in:
          date:
            link:
            - Get Time After Get/date
            - Get Time After Get With DC/date
      Set enable_masking:
        parent: FabricSet
        in:
          key:
            const: enable_masking
            default: false
          value:
            const: null
            link: Get Load Masking Flag/result
            default: false
      Get Sequences Flag:
        parent: FabricSetRead
        in:
          key:
            const: enable_sequences
            default: false
  'set Enable_Masking_uniqueness ':
    transactional: false
    dependsOn: Set Environment To Target
    actors:
      Sequence or Load masking are enabled:
        parent: Or
        condition: result
        in:
          a:
            link: Get Load Masking Flag/result
          b:
            link: Get Sequences Flag/result
      Set Enable_Masking_uniqueness to true:
        parent: FabricSet
        in:
          key:
            const: enable_masking_uniqueness
            default: false
          value:
            const: 'true'
            default: false
    split: '--------------------'
  Set to false:
    else: true
    transactional: false
    dependsOn: Set Environment To Target
    actors:
      Set Enable_Masking_uniqueness to false:
        parent: FabricSet
        in:
          key:
            const: enable_masking_uniqueness
            default: false
          value:
            const: 'false'
            default: false
  Set End Time of Get:
    transactional: false
    actors:
      Set End Time of Get Command:
        parent: FabricSet
        in:
          key:
            const: IID_AFTER_GET_DATETIME
            default: false
          value:
            link: Format Current Time/string
schemas:
  Get Selection Method.out.result:
    type: array
    items:
      type: object
      properties:
        selection_method:
          type: string
  Get Root Lui and Name.out.result:
    type: array
    items:
      type: object
      properties:
        root_lu_name:
          type: string
        root_imported_lui:
          type: string
  Get Entity.out.result:
    type: object
    properties:
      luName:
        type: string
      iid:
        type: string
      version:
        type: integer
      action:
        type: string
  Get Entity with Source DC.out.result:
    type: array
    items:
      type: object
      properties:
        luName:
          type: string
        iid:
          type: string
        version:
          type: integer
        action:
          type: string
        notes:
          type: string
