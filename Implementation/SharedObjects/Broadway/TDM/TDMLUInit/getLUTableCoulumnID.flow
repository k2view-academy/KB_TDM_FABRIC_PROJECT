tags: TDM
stages:
  Stage 1:
    actors:
      JsonParser1:
        parent: JsonParser
        in:
          stream:
            external: TABLE_LIST
        out:
          object:
            schema: '#ref'
  Stage 2:
    actors:
      StringFormat1:
        parent: StringFormat
        in:
          format:
            const: Tables/${TABLE_NAME}.k2table.xml
          TABLE_NAME:
            link:
              path: JsonParser1/object/table_name
              iterate: Iterate
            schema: string
            mandatory: false
          params:
            link: JsonParser1/object
  Stage 3:
    actors:
      FileRead1:
        parent: FileRead
        in:
          interface:
            const: null
            external: LU_PATH
          path:
            link: StringFormat1/string
  Stage 4:
    actors:
      XmlParser1:
        parent: XmlParser
        in:
          stream:
            link: FileRead1/stream
        out:
          object:
            schema: '#ref'
          info:
            schema: '#ref'
  Stage 5:
    dependsOn: Stage 4
    actors:
      EqualsIgnoreCase1:
        parent: EqualsIgnoreCase
        condition: result
        in:
          a:
            link:
              path: JsonParser1/object/column_name
              iterate: Iterate
          b:
            link:
              path: XmlParser1/object/TableObject/_value/Columns/_value/Column/_attributes/name
              iterate: Iterate
      MapBuild1:
        parent: MapBuild
        in:
          key:
            const: id
            schema: string
          value:
            link:
              path: XmlParser1/object/TableObject/_value/Columns/_value/Column/_attributes/id
              iterate: Iterate
        out:
          map:
            schema: '#ref'
    split: '--------------------'
  Stage 9:
    else: true
    dependsOn: Stage 4
    actors:
      JsonParser2:
        parent: JsonParser
        in:
          stream:
            link: XmlParser1/object/TableObject/_value/IndexesList
        out:
          object:
            schema: '#ref'
  Stage 10:
    dependsOn: Stage 5
    split: '--------------------'
  Stage 11:
    dependsOn: Stage 9
    actors:
      EqualsIgnoreCase2:
        parent: EqualsIgnoreCase
        condition: result
        in:
          a:
            link:
              path: JsonParser1/object/column_name
              iterate: Iterate
          b:
            link: JsonParser2/object/Index/_attributes/columnsIdsList
      MapBuild2:
        parent: MapBuild
        in:
          key:
            const: id
            schema: string
          value:
            link: JsonParser2/object/Index/_attributes/columnsIdsList
        out:
          map:
            schema: '#ref'
          previous:
            schema: '#ref'
  Stage 6:
    last: 1
    actors:
      MapMerge1:
        parent: MapMerge
        in:
          maps:
            link:
            - path: JsonParser1/object
              iterate: Iterate
              pos: 0
            - path: MapBuild1/map
              pos: 1
            - path: MapBuild2/map
              pos: 2
        out:
          map:
            schema: '#ref'
  Stage 7:
    last: 1
    actors:
      StringBuild1:
        parent: StringBuild
        in:
          input:
            link:
              path: MapMerge1/map
              pos: 0
  Stage 8:
    actors:
      StringFormat2:
        parent: StringFormat
        in:
          format:
            const: '[${table_info}]'
          table_info:
            link: StringBuild1/string
            schema: string
            mandatory: false
        out:
          string:
            external: tables
schemas:
  JsonParser1.out.object:
    type: array
    items:
      type: object
      properties:
        table_name:
          type: string
        column_name:
          type: string
        active:
          type: boolean
        population:
          type: array
          items:
            type: string
  XmlParser1.out.object:
    type: object
    properties:
      TableObject:
        type: object
        properties:
          _value:
            type: object
            properties:
              Name:
                type: object
                properties:
                  _value:
                    type: string
              ID:
                type: object
                properties:
                  _value:
                    type: string
              LazyDataUpdate:
                type: object
                properties:
                  _attributes:
                    type: object
                    properties:
                      syncMethod:
                        type: string
                      performEvery:
                        type: string
                  _value:
                    type: object
                    properties:
                      TruncateBeforeSync:
                        type: object
                        properties:
                          _value:
                            type: string
              Columns:
                type: object
                properties:
                  _value:
                    type: object
                    properties:
                      Column:
                        type: array
                        items:
                          type: object
                          properties:
                            _attributes:
                              type: object
                              properties:
                                name:
                                  type: string
                                id:
                                  type: string
                                index:
                                  type: string
                                datatype:
                                  type: string
              IndexesList:
                type: object
                properties: {
                  }
              EnrichmentList:
                type: object
                properties:
                  _value:
                    type: object
                    properties:
                      Enrichment:
                        type: object
                        properties:
                          _value:
                            type: object
                            properties:
                              Name:
                                type: object
                                properties:
                                  _value:
                                    type: string
                              Type:
                                type: object
                                properties:
                                  _value:
                                    type: string
                              TableName:
                                type: object
                                properties:
                                  _value:
                                    type: string
  XmlParser1.out.info:
    type: object
    properties:
      version:
        type: string
      standalone:
        type: boolean
      header:
        type: string
  MapBuild1.out.map:
    type: object
    properties:
      id:
        type: string
  JsonParser2.out.object:
    type: object
    properties:
      Index:
        type: object
        properties:
          _attributes:
            type: object
            properties:
              id:
                type: string
              pk:
                type: string
              unique:
                type: string
              instanceOnly:
                type: string
              columnsIdsList:
                type: string
  MapBuild2.out.map:
    type: object
    properties:
      id:
        type: string
  MapBuild2.out.previous:
    type: object
    properties:
      _value:
        type: object
        properties:
          Index:
            type: object
            properties:
              _attributes:
                type: object
                properties:
                  id:
                    type: string
                  pk:
                    type: string
                  unique:
                    type: string
                  instanceOnly:
                    type: string
                  columnsIdsList:
                    type: string
  MapMerge1.out.map:
    type: object
    properties:
      table_name:
        type: string
      column_name:
        type: string
      active:
        type: boolean
      population:
        type: array
        items:
          type: string
      id:
        type: string
