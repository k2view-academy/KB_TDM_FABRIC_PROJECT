tags: TDM
stages:
  Stage 1:
    actors:
      TDM_LIBRARY folder:
        parent: StringFormat
        in:
          format:
            const: ${TDM_LIBRARY_PATH}Tables/
          TDM_LIBRARY_PATH:
            external: TDM_LIBRARY_PATH
            schema: string
            mandatory: false
      LU Folder:
        parent: StringFormat
        in:
          format:
            const: ${LU_PATH}Tables/
          LU_PATH:
            external: LU_PATH
            schema: string
            mandatory: false
  Stage 2:
    actors:
      ls TDM_LIBRARY tables:
        parent: ls
        in:
          interface:
            const: null
            link: TDM_LIBRARY folder/string
          path:
            const: .
        out:
          result:
            schema: '#ref'
  Stage 9:
    actors:
      Replace Table extension:
        parent: Replace
        height: 282
        in:
          search:
            const: .k2table.xml
          string:
            link:
              path: ls TDM_LIBRARY tables/result/name
              iterate: Iterate
  Stage 3:
    actors:
      Concat1:
        parent: Concat
        in:
          delimiter:
            const: ''
          elements:
            link:
            - path: TDM_LIBRARY folder/string
              pos: 0
            - path: ls TDM_LIBRARY tables/result/name
              iterate: Iterate
              pos: 1
      Concat2:
        parent: Concat
        in:
          delimiter:
            const: ''
          elements:
            link:
            - path: LU Folder/string
              pos: 0
            - path: ls TDM_LIBRARY tables/result/name
              iterate: Iterate
              pos: 1
      Lookup1:
        parent: Lookup
        in:
          lookupKeys:
            const:
            - table_name
          lookupData:
            const:
            - table_name: FABRIC_TDM_ROOT
              column_name: IID
              active: true
            - table_name: LU_PARAMS
              column_name: ENTITY_ID
              active: true
            - table_name: TDM_LU_TYPE_REL_TAR_EID
              column_name: lu_type1_eid
              active: true
            - table_name: TDM_LU_TYPE_RELATION_EID
              column_name: lu_type1_eid
              active: true
            - table_name: TDM_BE_IIDS
              column_name: iid,source_env,be_id,root_iid
              active: true
            schema: '#ref'
          table_name:
            link: Replace Table extension/string
            schema: string
            mandatory: false
        out:
          result:
            schema: '#ref'
      Table Population file:
        parent: StringFormat
        in:
          format:
            const: ${tableName}.*.flow
          tableName:
            link: Replace Table extension/string
            schema: string
            mandatory: false
  Stage 4:
    actors:
      Replace file:// TDM LIBRARY:
        parent: Replace
        in:
          search:
            const: file://
          string:
            link: Concat1/string
      Replace file:// LU_PATH:
        parent: Replace
        in:
          search:
            const: file://
          string:
            link: Concat2/string
  Stage 16:
    actors:
      Copy file:
        parent: cp
        in:
          interface:
            const: file://
          from:
            link: Replace file:%2F%2F TDM LIBRARY/string
          to:
            link: Replace file:%2F%2F LU_PATH/string
  Stage 5:
    actors:
      Equals1:
        parent: Equals
        condition: result
        in:
          b:
            const: true
            schema: boolean
          a:
            link: Lookup1/result/active
      List populations:
        parent: ls
        in:
          interface:
            const: null
            link: TDM_LIBRARY folder/string
          path:
            const: .
          pattern:
            const: null
            link: Table Population file/string
        out:
          result:
            schema: '#ref'
  Stage 7:
    last: 1
    dependsOn: Stage 5
    actors:
      JavaScript1:
        parent: JavaScript
        condition: result
        in:
          script:
            const:
              userCode: "var result = true;\r\nif(population == null || population\
                \ == []) {\r\n    result = false;\r\n}\r\nresult;"
              script: |-
                var result = true;

                if (population == null || population == []) {
                  result = false;
                }

                result;
          population:
            link:
              path: List populations/result
              iterate: Iterate
            schema: '#ref'
            mandatory: false
        out:
          result:
            schema: boolean
      MapBuild1:
        parent: MapBuild
        in:
          key:
            const: population
            schema: string
          value:
            link:
              path: List populations/result/name
              iterate: Iterate
        out:
          map:
            schema: '#ref'
    split: '--------------------'
  Stage 11:
    last: 1
    else: true
    transactional: false
    dependsOn: Stage 5
    actors:
      MapBuild2:
        parent: MapBuild
        in:
          key:
            const: population
            schema: string
        out:
          map:
            schema: '#ref'
  Stage 12:
    actors:
      MapMerge1:
        parent: MapMerge
        in:
          maps:
            link:
            - path: Lookup1/result
              pos: 0
            - path: MapBuild1/map
              pos: 1
            - path: MapBuild2/map
              pos: 1
        out:
          map:
            schema: '#ref'
  Stage 10:
    actors:
      StringBuild1:
        parent: StringBuild
        in:
          input:
            link:
              path: MapMerge1/map
              pos: 0
            mandatory: false
  Stage 6:
    last: 1
  Stage 8:
    transactional: false
    actors:
      StringFormat1:
        parent: StringFormat
        in:
          format:
            const: '[${TABLES_INFO}]'
          TABLES_INFO:
            link: StringBuild1/string
            schema: string
            mandatory: false
        out:
          string:
            external: table_id
schemas:
  ls TDM_LIBRARY tables.out.result:
    type: array
    items:
      type: object
      properties:
        name:
          type: string
        size:
          type: integer
        createTime:
          type: integer
        lastModifiedTime:
          type: integer
        lastAccessTime:
          type: integer
        directory:
          type: boolean
  Lookup1.in.lookupData:
    type: array
    items:
      type: object
      properties:
        table_name:
          type: string
        column_name:
          type: string
        active:
          type: boolean
  Lookup1.out.result:
    type: object
    properties:
      table_name:
        type: string
      column_name:
        type: string
      active:
        type: boolean
  List populations.out.result:
    type: array
    items:
      type: object
      properties:
        name:
          type: string
        size:
          type: integer
        createTime:
          type: integer
        lastModifiedTime:
          type: integer
        lastAccessTime:
          type: integer
        directory:
          type: boolean
  JavaScript1.in.population:
    type: object
    properties:
      name:
        type: string
      size:
        type: integer
      createTime:
        type: integer
      lastModifiedTime:
        type: integer
      lastAccessTime:
        type: integer
      directory:
        type: boolean
  MapBuild1.out.map:
    type: object
    properties:
      population:
        type: array
        items:
          type: string
  MapBuild2.out.map:
    type: object
    properties:
      population:
        type: array
        items:
          type: string
  MapMerge1.out.map:
    type: object
    properties:
      table_name:
        type: string
      column_name:
        type: string
      active:
        type: boolean
      population:
        type: array
        items:
          type: string
