tags: TDM
stages:
  Get Business Entity Name:
    actors:
      BE name:
        parent: DbFetchField
        in:
          interface:
            const: TDM
          sql:
            const: |-
              select be.be_name as be_name from @TDMDB_SCHEMA@.business_entities be ,@TDMDB_SCHEMA@.product_logical_units pl inner join @TDMDB_SCHEMA@.tasks_logical_units tl
              on tl.lu_id = pl.lu_id where tl.task_id=${task_id} and pl.lu_parent_name=${lu_name} and pl.be_id = be.be_id limit 1;
          task_id:
            external: task_id
            schema: integer
            mandatory: false
          lu_name:
            external: parentLU
            schema: string
            mandatory: false
        out:
          result:
            schema: string
  Get Lu Children:
    actors:
      Product Logical Unit:
        parent: DbCommand
        in:
          interface:
            const: TDM
          sql:
            const: |-
              select pl.lu_name as lu_child_name from @TDMDB_SCHEMA@.product_logical_units pl inner join @TDMDB_SCHEMA@.tasks_logical_units tl
              on tl.lu_id = pl.lu_id where tl.task_id=${task_id} and pl.lu_parent_name=${lu_name};
          lu_name:
            external: parentLU
            schema: string
            mandatory: false
          task_id:
            external: task_id
            schema: integer
            mandatory: false
        out:
          result:
            schema: '#ref'
  Parse Children Names:
    actors:
      Child Name:
        parent: JavaScript
        in:
          script:
            const:
              userCode: "for(var p in input) {\r\n    if (p === 'lu_child_name'){\r\
                \n        self.result = input[p]\r\n    }\r\n}"
              script: |-
                for (var p in input) {
                  if (p === 'lu_child_name') {
                    self.result = input[p];
                  }
                }
          input:
            link:
              path: Product Logical Unit/result
              iterate: Iterate
            schema: '#ref'
            mandatory: false
        out:
          result:
            schema: string
  Get Num Of Entities Per LU: {
    }
  Get Generated IIDs:
    actors:
      ReturnGeneratedIIDs:
        parent: ReturnGeneratedIIDs
        in:
          lu_name:
            external: lu_name
          task_execution_id:
            external: task_execution_id
  Indication Of Delete Before Load:
    actors:
      TDM_DELETE_BEFORE_LOAD:
        parent: FabricSetRead
        in:
          key:
            const: TDM_DELETE_BEFORE_LOAD
  Delete Before Load:
    dependsOn: Indication Of Delete Before Load
    actors:
      'True':
        parent: EqualsIgnoreCase
        condition: result
        in:
          b:
            const: 'true'
            schema: string
          a:
            link: TDM_DELETE_BEFORE_LOAD/result
    split: '--------------------'
  'False':
    else: true
    transactional: false
    dependsOn: Indication Of Delete Before Load
  'Insert Into Tdm Relation Target Table ':
    transactional: false
    dependsOn: Delete Before Load
    actors:
      'tdm_lu_type_rel_tar_eid ':
        parent: DbLoad
        in:
          interface:
            const: TDM
          schema:
            const: '@TDMDB_SCHEMA@'
          table:
            const: tdm_lu_type_rel_tar_eid
          fields:
            const:
            - target_env
            - lu_type_1
            - lu_type_2
            - lu_type1_eid
            - lu_type2_eid
            - creation_date
          keys:
            const:
            - target_env
            - lu_type_1
            - lu_type_2
            - lu_type1_eid
            - lu_type2_eid
          dialect:
            const: postgres
          target_env:
            external: targetEnv
            schema: any
            mandatory: false
          lu_type_1:
            external: parentLU
            schema: any
            mandatory: false
          lu_type_2:
            link: Child Name/result
            schema: any
            mandatory: false
          lu_type1_eid:
            external: instanceId
            schema: any
            mandatory: false
          lu_type2_eid:
            link:
              path: ReturnGeneratedIIDs/array
              iterate: Iterate
            schema: any
            mandatory: false
          creation_date:
            external: currDate
            schema: any
            mandatory: false
    split: '--------------------'
  'Insert Into Tdm Relation Table ':
    transactional: false
    dependsOn: 'False'
    actors:
      tdm_lu_type_relation_eid:
        parent: DbLoad
        in:
          interface:
            const: TDM
          schema:
            const: '@TDMDB_SCHEMA@'
          table:
            const: tdm_lu_type_relation_eid
          fields:
            const:
            - source_env
            - lu_type_1
            - lu_type_2
            - lu_type1_eid
            - lu_type2_eid
            - creation_date
            - version_name
            - version_datetime
          keys:
            const:
            - source_env
            - lu_type_1
            - lu_type_2
            - lu_type1_eid
            - lu_type2_eid
            - version_name
            - version_datetime
          dialect:
            const: postgres
          source_env:
            external: srcEnv
            schema: string
            mandatory: false
          lu_type_1:
            external: parentLU
            schema: string
            mandatory: false
          lu_type_2:
            link: Child Name/result
            schema: string
            mandatory: false
          lu_type1_eid:
            external: instanceId
            schema: string
            mandatory: false
          lu_type2_eid:
            link:
              path: ReturnGeneratedIIDs/array
              iterate: Iterate
            schema: integer
            mandatory: false
          creation_date:
            external: currDate
            schema: string
            mandatory: false
          version_name:
            external: verName
            schema: string
            mandatory: false
          version_datetime:
            external: verDateTime
            schema: string
            mandatory: false
  'Insert Into Fabric Relation Target Table ':
    dependsOn: 'Insert Into Tdm Relation Target Table '
    actors:
      fabric tdm_lu_type_rel_tar_eid:
        parent: DbLoad
        in:
          interface:
            const: fabric
          schema:
            const: null
            external: parentLU
          table:
            const: tdm_lu_type_rel_tar_eid
          fields:
            const:
            - TARGET_ENV
            - LU_TYPE_1
            - LU_TYPE_2
            - LU_TYPE1_EID
            - LU_TYPE2_EID
            - CREATION_DATE
          LU_TYPE_1:
            external: parentLU
            schema: any
            mandatory: false
          LU_TYPE_2:
            link: Child Name/result
            schema: any
            mandatory: false
          LU_TYPE1_EID:
            external: instanceId
            schema: any
            mandatory: false
          LU_TYPE2_EID:
            link:
              path: ReturnGeneratedIIDs/array
              iterate: Iterate
            schema: any
            mandatory: false
          CREATION_DATE:
            external: currDate
            schema: any
            mandatory: false
          TARGET_ENV:
            external: targetEnv
            schema: any
            mandatory: false
    split: '--------------------'
  'Insert Into Fabric Relation Table ':
    transactional: false
    dependsOn: 'Insert Into Tdm Relation Table '
    actors:
      fabric tdm_lu_type_relation_eid:
        parent: DbLoad
        in:
          interface:
            const: fabric
          schema:
            const: null
            external: parentLU
          table:
            const: tdm_lu_type_relation_eid
          fields:
            const:
            - SOURCE_ENV
            - LU_TYPE_1
            - LU_TYPE_2
            - LU_TYPE1_EID
            - LU_TYPE2_EID
            - CREATION_DATE
            - VERSION_NAME
            - VERSION_DATETIME
          LU_TYPE_1:
            external: parentLU
            schema: string
            mandatory: false
          LU_TYPE_2:
            link: Child Name/result
            schema: string
            mandatory: false
          LU_TYPE1_EID:
            external: instanceId
            schema: string
            mandatory: false
          LU_TYPE2_EID:
            link:
              path: ReturnGeneratedIIDs/array
              iterate: Iterate
            schema: integer
            mandatory: false
          currDate:
            external: currDate
            schema: string
            mandatory: false
          SOURCE_ENV:
            external: srcEnv
            schema: string
            mandatory: false
          VERSION_NAME:
            external: verName
            schema: string
            mandatory: false
          VERSION_DATETIME:
            external: verDateTime
            schema: string
            mandatory: false
  Stage 1: {
    }
schemas:
  Product Logical Unit.out.result:
    type: array
    items:
      type: object
      properties:
        lu_child_name:
          type: string
  Child Name.in.input:
    type: object
    properties:
      lu_child_name:
        type: string
