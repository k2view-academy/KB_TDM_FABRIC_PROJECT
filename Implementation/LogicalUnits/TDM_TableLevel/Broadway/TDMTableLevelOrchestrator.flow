{
    "levels": [
        {
            "stages": [
                {
                    "name": "Initiate",
                    "dependsOnList": [],
                    "isLast": 0,
                    "actors": [
                        {
                            "name": "Get Start Time",
                            "actorType": {
                                "parentType": "Now",
                                "inputs": [],
                                "outputs": []
                            }
                        },
                        {
                            "name": "Logger1",
                            "actorType": {
                                "parentType": "Logger",
                                "inputs": [
                                    {
                                        "name": "message",
                                        "const": "Starting TDMTableLevelOrchestrator for Table Instance: ${table}"
                                    },
                                    {
                                        "name": "level",
                                        "const": "info"
                                    },
                                    {
                                        "name": "table",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "mandatory": false
                                    }
                                ],
                                "outputs": []
                            }
                        },
                        {
                            "name": "Get Table Instance Fields",
                            "actorType": {
                                "parentType": "InnerFlow",
                                "inputs": [
                                    {
                                        "name": "flowName",
                                        "const": "GetTableInstanceFields"
                                    },
                                    {
                                        "name": "ref_instance_id",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "mandatory": false
                                    }
                                ],
                                "outputs": [
                                    {
                                        "name": "result",
                                        "schema": {
                                            "type": "object",
                                            "properties": {
                                                "source_env": {
                                                    "type": "string"
                                                },
                                                "interface_name": {
                                                    "type": "string"
                                                },
                                                "schema_name": {
                                                    "type": "string"
                                                },
                                                "table_name": {
                                                    "type": "string"
                                                },
                                                "task_execution_id": {
                                                    "type": "string"
                                                }
                                            }
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            "name": "Initiate Entity Status",
                            "actorType": {
                                "parentType": "FabricSet",
                                "inputs": [
                                    {
                                        "name": "key",
                                        "const": "ENTITY_STATUS",
                                        "isDefault": false
                                    },
                                    {
                                        "name": "value",
                                        "const": "completed",
                                        "isDefault": false
                                    }
                                ],
                                "outputs": []
                            }
                        },
                        {
                            "name": "Set Lu Name",
                            "actorType": {
                                "parentType": "FabricSet",
                                "inputs": [
                                    {
                                        "name": "key",
                                        "const": "LU_TYPE",
                                        "isDefault": false
                                    },
                                    {
                                        "name": "value",
                                        "const": "TDM_TableLevel",
                                        "isDefault": false
                                    }
                                ],
                                "outputs": []
                            }
                        },
                        {
                            "name": "Set root_lu_name",
                            "actorType": {
                                "parentType": "FabricSet",
                                "inputs": [
                                    {
                                        "name": "key",
                                        "const": "root_lu_name",
                                        "isDefault": false
                                    },
                                    {
                                        "name": "value",
                                        "const": "TDM_TableLevel",
                                        "isDefault": false
                                    }
                                ],
                                "outputs": []
                            }
                        }
                    ]
                }
            ]
        },
        {
            "stages": [
                {
                    "name": "Get and Set Parameters",
                    "dependsOnList": [],
                    "isLast": 0,
                    "actors": [
                        {
                            "name": "Format Start Time",
                            "actorType": {
                                "parentType": "DateFormat",
                                "inputs": [],
                                "outputs": []
                            }
                        },
                        {
                            "name": "Get Executor Name",
                            "actorType": {
                                "parentType": "FabricSetRead",
                                "inputs": [
                                    {
                                        "name": "key",
                                        "const": "USER_NAME",
                                        "isDefault": false
                                    }
                                ],
                                "outputs": []
                            }
                        },
                        {
                            "name": "Get Task Execution ID",
                            "actorType": {
                                "parentType": "FabricSetRead",
                                "inputs": [
                                    {
                                        "name": "key",
                                        "const": "TDM_TASK_EXE_ID",
                                        "isDefault": false
                                    }
                                ],
                                "outputs": []
                            }
                        },
                        {
                            "name": "Initiate Target Entity ID after IID Split",
                            "remark": "The Target Entity ID should be initiated in case the flows fails during the next stage and before setting this ID as it is used in the Error handler",
                            "actorType": {
                                "parentType": "FabricSet",
                                "inputs": [
                                    {
                                        "name": "key",
                                        "const": "TARGET_ENTITY_ID",
                                        "isDefault": false
                                    },
                                    {
                                        "name": "value",
                                        "const": null,
                                        "isDefault": false
                                    }
                                ],
                                "outputs": []
                            }
                        },
                        {
                            "name": "Set root_iid",
                            "actorType": {
                                "parentType": "FabricSet",
                                "inputs": [
                                    {
                                        "name": "key",
                                        "const": "root_iid",
                                        "isDefault": false
                                    },
                                    {
                                        "name": "value",
                                        "const": null,
                                        "isDefault": false
                                    }
                                ],
                                "outputs": []
                            }
                        }
                    ]
                }
            ]
        },
        {
            "stages": [
                {
                    "name": "Sync Mode to OFF",
                    "dependsOnList": [
                        "Get and Set Parameters"
                    ],
                    "isLast": 0,
                    "isTransactional": false,
                    "actors": [
                        {
                            "name": "Set Sync Mode to OFF?",
                            "condition": "result",
                            "actorType": {
                                "parentType": "JavaScript",
                                "inputs": [
                                    {
                                        "name": "script",
                                        "const": {
                                            "userCode": "var result = false;\r\nif(syncMode.toUpperCase() != 'FORCE' && taskType.toUpperCase() == 'EXTRACT' && taskExeId != versionTaskExeID) {\r\n    result = true;\r\n}\r\nresult;",
                                            "script": "var result = false;\n\nif (syncMode.toUpperCase() != 'FORCE' && taskType.toUpperCase() == 'EXTRACT' && taskExeId != versionTaskExeID) {\n  result = true;\n}\n\nresult;"
                                        }
                                    },
                                    {
                                        "name": "syncMode",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "mandatory": false
                                    },
                                    {
                                        "name": "taskType",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "mandatory": false
                                    },
                                    {
                                        "name": "taskExeId",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "mandatory": false
                                    },
                                    {
                                        "name": "versionTaskExeID",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "mandatory": false
                                    }
                                ],
                                "outputs": [
                                    {
                                        "name": "result",
                                        "schema": {
                                            "type": "boolean"
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            "name": "Sync Mode Set to OFF",
                            "actorType": {
                                "parentType": "Const",
                                "inputs": [
                                    {
                                        "name": "value",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "const": "OFF"
                                    }
                                ],
                                "outputs": [
                                    {
                                        "name": "value",
                                        "schema": {
                                            "type": "string"
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                },
                {
                    "name": "No Change in Sync Mode",
                    "dependsOnList": [
                        "Get and Set Parameters"
                    ],
                    "isLast": 0,
                    "isTransactional": false,
                    "hasElse": true,
                    "actors": [
                        {
                            "name": "Keep Sync Mode as is",
                            "actorType": {
                                "parentType": "Const",
                                "inputs": [
                                    {
                                        "name": "value",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "const": null
                                    }
                                ],
                                "outputs": [
                                    {
                                        "name": "value",
                                        "schema": {
                                            "type": "string"
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            ]
        },
        {
            "stages": [
                {
                    "name": "Set Source Environment",
                    "dependsOnList": [],
                    "isLast": 0,
                    "isTransactional": false,
                    "actors": [
                        {
                            "name": "set Source Env",
                            "actorType": {
                                "parentType": "InnerFlow",
                                "inputs": [
                                    {
                                        "name": "flowName",
                                        "const": "setSourceEnv"
                                    }
                                ],
                                "outputs": []
                            }
                        },
                        {
                            "name": "Update Table Status to Running",
                            "actorType": {
                                "parentType": "DbCommand",
                                "inputs": [
                                    {
                                        "name": "interface",
                                        "const": "TDM"
                                    },
                                    {
                                        "name": "sql",
                                        "const": "update @TDMDB_SCHEMA@.task_ref_exe_stats\r\nset execution_status = 'running',\r\nstart_time = CURRENT_TIMESTAMP AT TIME ZONE 'UTC', \r\nupdated_by = ${userName}\r\nwhere task_execution_id = ${taskExeId} \r\nand ref_table_name = ${tableName}"
                                    },
                                    {
                                        "name": "userName",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "mandatory": false
                                    },
                                    {
                                        "name": "taskExeId",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "mandatory": false
                                    },
                                    {
                                        "name": "tableName",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "mandatory": false
                                    }
                                ],
                                "outputs": []
                            }
                        }
                    ]
                }
            ]
        },
        {
            "stages": [
                {
                    "name": "Sync Table",
                    "dependsOnList": [],
                    "isLast": 0,
                    "isTransactional": false,
                    "actors": [
                        {
                            "name": "Sync Error Handler",
                            "onError": "result",
                            "actorType": {
                                "parentType": "ErrorHandler",
                                "inputs": [
                                    {
                                        "name": "config",
                                        "const": [
                                            {
                                                "exceptionKey": "java.lang.Exception",
                                                "conditions": {
                                                    "message": ""
                                                },
                                                "actions": {
                                                    "suppress": false,
                                                    "log": true,
                                                    "flowName": "PopulateTableErrorsForTableLevel"
                                                }
                                            }
                                        ]
                                    }
                                ],
                                "outputs": []
                            }
                        },
                        {
                            "name": "Set Start Processing Time",
                            "actorType": {
                                "parentType": "FabricSet",
                                "inputs": [
                                    {
                                        "name": "key",
                                        "const": "IID_START_DATETIME",
                                        "isDefault": false
                                    },
                                    {
                                        "name": "value",
                                        "const": null,
                                        "isDefault": false
                                    }
                                ],
                                "outputs": []
                            }
                        },
                        {
                            "name": "Get Instance",
                            "actorType": {
                                "parentType": "FabricGet",
                                "inputs": [
                                    {
                                        "name": "luType",
                                        "const": "TDM_TableLevel"
                                    },
                                    {
                                        "name": "iid",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "const": null,
                                        "isDefault": false
                                    },
                                    {
                                        "name": "syncMode",
                                        "const": null
                                    }
                                ],
                                "outputs": []
                            }
                        }
                    ]
                }
            ]
        },
        {
            "stages": [
                {
                    "name": "Load to Target",
                    "dependsOnList": [
                        "Sync Table"
                    ],
                    "isLast": 0,
                    "isTransactional": false,
                    "actors": [
                        {
                            "name": "If Load Task",
                            "condition": "result",
                            "actorType": {
                                "parentType": "Equals",
                                "inputs": [
                                    {
                                        "name": "a",
                                        "schema": {
                                            "type": "string"
                                        }
                                    },
                                    {
                                        "name": "b",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "const": "load"
                                    }
                                ],
                                "outputs": []
                            }
                        },
                        {
                            "name": "Load Error Handler",
                            "onError": "result",
                            "actorType": {
                                "parentType": "ErrorHandler",
                                "inputs": [
                                    {
                                        "name": "config",
                                        "const": [
                                            {
                                                "exceptionKey": "java.lang.Exception",
                                                "conditions": {
                                                    "message": ""
                                                },
                                                "actions": {
                                                    "suppress": false,
                                                    "log": true,
                                                    "flowName": "PopulateTableErrorsForTableLevel"
                                                }
                                            }
                                        ]
                                    }
                                ],
                                "outputs": []
                            }
                        },
                        {
                            "name": "load Table to Target",
                            "actorType": {
                                "parentType": "InnerFlow",
                                "inputs": [
                                    {
                                        "name": "flowName",
                                        "const": "load_TableLevel"
                                    },
                                    {
                                        "name": "refInstanceId",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "mandatory": false
                                    }
                                ],
                                "outputs": []
                            }
                        }
                    ]
                },
                {
                    "name": "Extract Only Task",
                    "dependsOnList": [
                        "Sync Table"
                    ],
                    "isLast": 0,
                    "isTransactional": false,
                    "hasElse": true,
                    "actors": []
                }
            ]
        },
        {
            "stages": [
                {
                    "name": "Update TDM DB Tables",
                    "dependsOnList": [],
                    "isLast": 0,
                    "isTransactional": false,
                    "actors": [
                        {
                            "name": "Populate Task Execution Entities",
                            "actorType": {
                                "parentType": "InnerFlow",
                                "inputs": [
                                    {
                                        "name": "flowName",
                                        "const": "PopulateTaskExecutionEntitiesForTables"
                                    },
                                    {
                                        "name": "luName",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "mandatory": false
                                    }
                                ],
                                "outputs": []
                            }
                        },
                        {
                            "name": "Update Table Status to Completed",
                            "actorType": {
                                "parentType": "DbCommand",
                                "inputs": [
                                    {
                                        "name": "interface",
                                        "const": "TDM"
                                    },
                                    {
                                        "name": "sql",
                                        "const": "update @TDMDB_SCHEMA@.task_ref_exe_stats\r\nset execution_status = 'completed',\r\nend_time = CURRENT_TIMESTAMP AT TIME ZONE 'UTC'\r\nwhere task_execution_id = ${taskExeId} \r\nand ref_table_name = ${tableName}"
                                    },
                                    {
                                        "name": "taskExeId",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "mandatory": false
                                    },
                                    {
                                        "name": "tableName",
                                        "schema": {
                                            "type": "string"
                                        },
                                        "mandatory": false
                                    }
                                ],
                                "outputs": []
                            }
                        }
                    ]
                }
            ]
        }
    ],
    "connections": [
        {
            "leftPort": {
                "actor": "Get Start Time",
                "name": "date"
            },
            "rightPort": {
                "actor": "Format Start Time",
                "name": "date"
            }
        },
        {
            "leftPort": {
                "actor": "Get Table Instance Fields",
                "name": "result"
            },
            "rightPort": {
                "actor": "Initiate Target Entity ID after IID Split",
                "name": "value"
            },
            "path": [
                "table_name"
            ]
        },
        {
            "leftPort": {
                "actor": "Get Table Instance Fields",
                "name": "result"
            },
            "rightPort": {
                "actor": "Set root_iid",
                "name": "value"
            },
            "path": [
                "table_name"
            ]
        },
        {
            "leftPort": {
                "actor": "Get Table Instance Fields",
                "name": "result"
            },
            "rightPort": {
                "actor": "Update Table Status to Completed",
                "name": "tableName"
            },
            "path": [
                "table_name"
            ]
        },
        {
            "leftPort": {
                "actor": "Get Table Instance Fields",
                "name": "result"
            },
            "rightPort": {
                "actor": "Set Sync Mode to OFF?",
                "name": "versionTaskExeID"
            },
            "path": [
                "task_execution_id"
            ]
        },
        {
            "leftPort": {
                "actor": "Format Start Time",
                "name": "string"
            },
            "rightPort": {
                "actor": "Set Start Processing Time",
                "name": "value"
            }
        },
        {
            "leftPort": {
                "actor": "Get Executor Name",
                "name": "result"
            },
            "rightPort": {
                "actor": "Update Table Status to Running",
                "name": "userName"
            }
        },
        {
            "leftPort": {
                "actor": "Get Task Execution ID",
                "name": "result"
            },
            "rightPort": {
                "actor": "Update Table Status to Running",
                "name": "taskExeId"
            }
        },
        {
            "leftPort": {
                "actor": "Get Task Execution ID",
                "name": "result"
            },
            "rightPort": {
                "actor": "Update Table Status to Completed",
                "name": "taskExeId"
            }
        },
        {
            "leftPort": {
                "actor": "Get Task Execution ID",
                "name": "result"
            },
            "rightPort": {
                "actor": "Set Sync Mode to OFF?",
                "name": "taskExeId"
            }
        },
        {
            "leftPort": {
                "actor": "Sync Mode Set to OFF",
                "name": "value"
            },
            "rightPort": {
                "actor": "Get Instance",
                "name": "syncMode"
            }
        },
        {
            "leftPort": {
                "actor": "Keep Sync Mode as is",
                "name": "value"
            },
            "rightPort": {
                "actor": "Get Instance",
                "name": "syncMode"
            }
        },
        {
            "leftPort": {
                "actor": "flowArgs",
                "name": "iid"
            },
            "rightPort": {
                "actor": "Logger1",
                "name": "table"
            }
        },
        {
            "leftPort": {
                "actor": "flowArgs",
                "name": "iid"
            },
            "rightPort": {
                "actor": "Get Table Instance Fields",
                "name": "ref_instance_id"
            }
        },
        {
            "leftPort": {
                "actor": "flowArgs",
                "name": "syncMode"
            },
            "rightPort": {
                "actor": "Set Sync Mode to OFF?",
                "name": "syncMode"
            }
        },
        {
            "leftPort": {
                "actor": "flowArgs",
                "name": "taskType"
            },
            "rightPort": {
                "actor": "Set Sync Mode to OFF?",
                "name": "taskType"
            }
        },
        {
            "leftPort": {
                "actor": "flowArgs",
                "name": "syncMode"
            },
            "rightPort": {
                "actor": "Keep Sync Mode as is",
                "name": "value"
            }
        },
        {
            "leftPort": {
                "actor": "flowArgs",
                "name": "iid"
            },
            "rightPort": {
                "actor": "Get Instance",
                "name": "iid"
            }
        },
        {
            "leftPort": {
                "actor": "flowArgs",
                "name": "taskType"
            },
            "rightPort": {
                "actor": "If Load Task",
                "name": "a"
            }
        },
        {
            "leftPort": {
                "actor": "flowArgs",
                "name": "iid"
            },
            "rightPort": {
                "actor": "load Table to Target",
                "name": "refInstanceId"
            }
        },
        {
            "leftPort": {
                "actor": "flowArgs",
                "name": "luName"
            },
            "rightPort": {
                "actor": "Populate Task Execution Entities",
                "name": "luName"
            }
        }
    ]
}