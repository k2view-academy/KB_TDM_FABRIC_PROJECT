tags: Create
stages:
  Set Env:
    actors:
      Production:
        parent: FabricSet
        in:
          key:
            const: environment
          value:
            const: Production
  Add column to source:
    actors:
      Add Column Birthday to Source:
        parent: DbCommand
        in:
          interface:
            const: CRM_DB
          sql:
            const: Alter Table public.customer Add Column if not exists birthday Date
              ;
  Get Customer ID:
    actors:
      Select Customer Data:
        parent: DbCommand
        in:
          interface:
            const: CRM_DB
          sql:
            const: select customer_id from public.customer
        out:
          result:
            schema: '#ref'
  Generate Birthday:
    actors:
      RandomRegexGenerator1:
        parent: RandomRegexGenerator
        in:
          regex:
            const: ^(19[7-9]\d|200\d)-(0[1-9]|1[0-2])-(0[1-9]|1\d|2[0-8])$
  Update Table:
    last: 1
    actors:
      Update Customer Data:
        parent: DbCommand
        in:
          interface:
            const: CRM_DB
          sql:
            const: update public.customer set birthday=${birthday} where customer_id=${id}
          id:
            link:
              path: Select Customer Data/result/customer_id
              iterate: Iterate
            schema: integer
            mandatory: false
          birthday:
            link: RandomRegexGenerator1/value
            schema: string
            mandatory: false
  'Set Env  ':
    actors:
      Development:
        parent: FabricSet
        in:
          key:
            const: environment
          value:
            const: Development
  Add column to tagret:
    actors:
      Add Column Birthday to Target:
        parent: DbCommand
        in:
          interface:
            const: CRM_DB
          sql:
            const: Alter Table public.customer Add Column if not exists birthday Date
              ;
schemas:
  Select Customer Data.out.result:
    type: array
    items:
      type: object
      properties:
        customer_id:
          type: integer
        first_name:
          type: string
        last_name:
          type: string
